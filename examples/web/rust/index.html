<!doctype html>
<html>
<title>wRPC WebTransport demo</title>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
    <title>wRPC WebTransport demo</title>
</head>

<body class="p-4">
    <script type="module">
        function setTemplate(option) {
            const defaultTemplate = document.querySelector('.form-fields[data-option=default]');
            const templateOutput = document.querySelector('#template-output');
            const template = document.querySelector(`.form-fields[data-option=${option}]`) ?? defaultTemplate;

            console.log('setting template to:', template.id, { option, template });
            templateOutput.innerHTML = template.innerHTML;
        }

        async function getBucket() {
            const form = document.querySelector('#settings');
            const formData = new FormData(form);
            const obj = Object.fromEntries(formData);

            let identifier;
            let conn = obj.connection;
            console.log("transport " + conn);
            if (conn === 'mem') {
                identifier = '';
            } else if (conn === 'nats') {
                let addr = obj['nats-addr'];
                if (addr == null || addr === '') {
                    alert("NATS.io server URL must be set");
                    return
                }
                identifier = 'wrpc+nats://' + addr;

                let prefix = obj['nats-prefix'];
                if (prefix != null && prefix != '') {
                    identifier = identifier + "/" + prefix;
                }

                let bucket = obj['nats-bucket'];
                if (bucket != null && bucket != '') {
                    identifier = identifier + ";" + bucket;
                }
            } else if (conn === 'quic') {
                let addr = obj.addr;
                if (addr == null || addr === '') {
                    alert("QUIC address must be set");
                    return
                }
                identifier = 'wrpc+quic://' + identifier;

                let bucket = obj.bucket;
                if (bucket != null && bucket != '') {
                    identifier = identifier + ";" + bucket;
                }
            } else if (conn === 'tcp') {
                let addr = obj['tcp-addr'];
                if (addr == null || addr === '') {
                    alert("TCP address must be set");
                    return
                }
                identifier = 'wrpc+tcp://' + addr;

                let bucket = obj.bucket;
                if (bucket != null && bucket != '') {
                    identifier = identifier + ";" + bucket;
                }
            } else if (conn === 'uds') {
                let addr = obj.addr;
                if (addr == null || addr === '') {
                    alert("Unix Domain Socket address must be set");
                    return
                }
                identifier = 'wrpc+uds://' + addr;

                let bucket = obj.bucket;
                if (bucket != null && bucket != '') {
                    identifier = identifier + ";" + bucket;
                }
            } else if (conn === 'web') {
                let addr = obj.addr;
                if (addr == null || addr === '') {
                    alert("WebTransport address must be set");
                    return
                }
                identifier = 'wrpc+web://' + addr;

                let bucket = obj.bucket;
                if (bucket != null && bucket != '') {
                    identifier = identifier + ";" + bucket;
                }
            } else {
                alert("transport not supported yet")
            }
            if (identifier.length >= 127) {
                alert("this demo does not support identifiers longer than 127 bytes - open a PR!");
                return
            }

            // TODO: cache the bucket by URL (it should not persist across server restarts)

            console.log('creating `open` stream for identifier `' + identifier + '`...');
            let stream = await transport.createBidirectionalStream();

            console.log('writing invocation...');
            let tx = stream.writable.getWriter();
            let rx = stream.readable.getReader();
            // TODO: just do one write
            await tx.write(new Uint8Array([0]));
            await tx.write(new Uint8Array(["wasi:keyvalue/store@0.2.0-draft2".length]));
            await tx.write(new TextEncoder().encode("wasi:keyvalue/store@0.2.0-draft2"));
            await tx.write(new Uint8Array(["open".length]));
            await tx.write(new TextEncoder().encode("open"));
            await tx.write(new Uint8Array([0]));
            await tx.write(new Uint8Array([1 + identifier.length]));
            await tx.write(new Uint8Array([identifier.length]));
            await tx.write(new TextEncoder().encode(identifier));
            tx.close();

            console.log('reading `open` response...');
            let data = await rx.read();
            console.log('received `open` response: ' + data.value);
            let res = data.value[2];
            if (res != 0) {
                alert("failed to open bucket")
                return;
            }
            let bucket = data.value.slice(3);
            console.log('opened bucket: ' + bucket);

            return bucket
        }

        async function handleGet() {
            const bucket = await getBucket();
            if (bucket == null) {
                return
            }
            const form = document.querySelector('#get');
            const formData = new FormData(form);
            const obj = Object.fromEntries(formData);
            let key = obj['get-key'];
            if (key == null || key === '') {
                alert("key must be set");
                return
            }
            if (key.length >= 127) {
                alert("this demo does not support keys longer than 127 bytes - open a PR!");
                return
            }

            console.log('creating `get` stream...');
            let stream = await transport.createBidirectionalStream();
            let tx = stream.writable.getWriter();
            let rx = stream.readable.getReader();
            // TODO: just do one write
            await tx.write(new Uint8Array([0]));
            await tx.write(new Uint8Array(["wasi:keyvalue/store@0.2.0-draft2".length]));
            await tx.write(new TextEncoder().encode("wasi:keyvalue/store@0.2.0-draft2"));
            await tx.write(new Uint8Array(["bucket.get".length]));
            await tx.write(new TextEncoder().encode("bucket.get"));
            await tx.write(new Uint8Array([0]));
            await tx.write(new Uint8Array([bucket.length + 1 + key.length]));
            await tx.write(bucket);
            await tx.write(new Uint8Array([key.length]));
            await tx.write(new TextEncoder().encode(key));
            tx.close();

            console.log('reading `get` response...');
            let data = await rx.read();
            console.log('received `get` response: ' + data.value);
            let res = data.value[2];
            if (res != 0) {
                alert("failed to get value")
                return;
            }
            let ok = data.value[3];
            if (ok != 1) {
                alert("key missing")
                return;
            }
            let value = new TextDecoder().decode(data.value.slice(5));

            document.querySelector('#get-response').textContent = JSON.stringify(value, null, 2);
        }

        async function handleSet() {
            const bucket = await getBucket();
            if (bucket == null) {
                return
            }
            const form = document.querySelector('#set');
            const formData = new FormData(form);
            const obj = Object.fromEntries(formData);
            let key = obj['set-key'];
            let value = obj['set-value'];
            if (key == null || key === '') {
                alert("key must be set");
                return
            }
            if (key.length >= 127) {
                alert("this demo does not support keys longer than 127 bytes - open a PR!");
                return
            }
            if (value == null || value === '') {
                alert("value must be set");
                return
            }
            if (value.length >= 127) {
                alert("this demo does not support value longer than 127 bytes - open a PR!");
                return
            }

            console.log('creating `set` stream...');
            let stream = await transport.createBidirectionalStream();
            let tx = stream.writable.getWriter();
            let rx = stream.readable.getReader();
            // TODO: just do one write
            await tx.write(new Uint8Array([0]));
            await tx.write(new Uint8Array(["wasi:keyvalue/store@0.2.0-draft2".length]));
            await tx.write(new TextEncoder().encode("wasi:keyvalue/store@0.2.0-draft2"));
            await tx.write(new Uint8Array(["bucket.set".length]));
            await tx.write(new TextEncoder().encode("bucket.set"));
            await tx.write(new Uint8Array([0]));
            await tx.write(new Uint8Array([bucket.length + 1 + key.length + 1 + value.length]));
            await tx.write(bucket);
            await tx.write(new Uint8Array([key.length]));
            await tx.write(new TextEncoder().encode(key));
            await tx.write(new Uint8Array([value.length]));
            await tx.write(new TextEncoder().encode(value));
            tx.close();

            console.log('reading `set` response...');
            let data = await rx.read();
            console.log('received `set` response: ' + data.value);
            let res = data.value[2];
            if (res != 0) {
                alert("failed to set value")
                return;
            }
        }

        function init() {
            setTemplate('mem');

            const connectionDropdown = document.querySelector('#connection');
            connectionDropdown.addEventListener('change', () => {
                setTemplate(connectionDropdown.value);
            });

            const settingsForm = document.querySelector('#settings');
            settingsForm.addEventListener('submit', (e) => {
                // no-op here, just to prevent accidental form submission
                e.preventDefault();
            });

            const getForm = document.querySelector('#get');
            getForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleGet();
            });

            const setForm = document.querySelector('#set');
            setForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSet();
            });
        }

        async function connect() {
            const { PORT, CERT_DIGEST } = await import('./consts.js');
            let transport;

            console.log('connecting to wRPC over WebTransport on `' + PORT + '`...');
            try {
                transport = new WebTransport("https://localhost:" + PORT, {
                    serverCertificateHashes: [
                        {
                            algorithm: "sha-256",
                            value: CERT_DIGEST.buffer
                        }
                    ]
                });
            } catch (e) {
                console.log('failed to connect: ' + e);
                return null;
            }

            console.log('waiting for readiness...');
            try {
                await transport.ready;
            } catch (e) {
                console.log('failed to await readiness: ' + e);
                return null;
            }
            return transport;
        }

        init();
        let transport = await connect();
        if (transport == null) {
            // TODO: Retry?
            alert("failed to connect to server")
        }

    </script>

    <section class="section columns">
        <div class="column">
            <h1 class="title">wRPC WebTransport demo</h1>
        </div>
        <div class="column is-narrow">
            <div class="select">
                <select id="connection" form="settings" name="connection">
                    <option value="mem">In-memory</option>
                    <option value="nats">NATS.io</option>
                    <option value="quic">QUIC</option>
                    <option value="tcp">TCP</option>
                    <option value="uds">Unix domain sockets</option>
                    <option value="web">WebTransport</option>
                </select>
            </div>
        </div>
    </section>

    <div class="section pt-0">
        <form id="settings">
            <div id="template-output">
            </div>

            <template class="form-fields" data-option="default">
                <div class="field">
                    <label class="label">Bucket identifier</label>
                    <div class="control">
                        <input class="input" type="text" name="bucket">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Target address</label>
                    <div class="control">
                        <input class="input" type="text" name="addr" placeholder="localhost:1234">
                    </div>
                </div>
            </template>

            <template class="form-fields" data-option="mem">
            </template>

            <template class="form-fields" data-option="nats">
                <div class="field">
                    <label class="label">Bucket identifier</label>
                    <div class="control">
                        <input class="input" type="text" name="nats-bucket">
                    </div>
                </div>
                <div class="field">
                    <label class="label">NATS.io server address</label>
                    <div class="control">
                        <input class="input" type="text" name="nats-addr" placeholder="localhost:4222" value="localhost:4222">
                    </div>
                </div>
                <div class="field">
                    <label class="label">NATS.io prefix</label>
                    <div class="control">
                        <input class="input" type="text" name="nats-prefix">
                    </div>
                </div>
            </template>

            <template class="form-fields" data-option="tcp">
                <div class="field">
                    <label class="label">Bucket identifier</label>
                    <div class="control">
                        <input class="input" type="text" name="tcp-bucket">
                    </div>
                </div>
                <div class="field">
                    <label class="label">TCP socket address</label>
                    <div class="control">
                        <input class="input" type="text" name="tcp-addr" placeholder="[::1]:7761" value="[::1]:7761">
                    </div>
                </div>
            </template>
        </form>
    </div>

    <div class="section columns">
        <div class="column">
            <h2 class="title is-4 has-text-centered">Get</h2>
            <form id="get">
                <div class="field is-horizontal">
                    <div class="field-body">
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <input class="input" name="get-key" placeholder="key" />
                            </div>
                            <div class="control">
                                <button type="submit" class="button is-primary">Get</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="mt-6">
                <pre><code id="get-response"></code></pre>
            </div>
        </div>
        <div class="column">
            <h2 class="title is-4 has-text-centered">Set</h2>
            <form id="set">
                <div class="field is-horizontal">
                    <div class="field-body">
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <input class="input" name="set-key" placeholder="key" />
                            </div>
                            <div class="control is-expanded">
                                <input class="input" name="set-value" placeholder="value" />
                            </div>
                            <div class="control">
                                <button type="submit" class="button is-primary">Set</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</body>

</html>
